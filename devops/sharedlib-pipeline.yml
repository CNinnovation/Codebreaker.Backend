# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
  branches:
    include:
    - main
  paths:  
    include:
    - src/shared/CodeBreaker.Shared

variables:
  buildConfiguration: 'Release'
  projectDirectory: 'src/shared/CodeBreaker.Shared'
  projectFile: 'src/shared/CodeBreaker.Shared/CodeBreaker.Shared.csproj'
  lib-version: 2.0-beta.1$(Build.BuildNumber)

stages:
  - stage: 'BuildAndPackage'
    displayName: 'Build and package the library'
    jobs:
    - job: BuildAndPackageJob
      displayName: 'Build and Package'
      pool:
        vmImage: ubuntu-latest

      steps:
      - script: |
          echo '$(lib-version)'
          dotnet build --configuration $(buildConfiguration) $(projectFile)
        displayName: 'dotnet build $(buildConfiguration)'

      - script: dotnet pack -c $(buildConfiguration) $(projectFile) /p:Version=$(lib-version) -o packages
        displayName: 'dotnet pack'
      
      - task: CopyFiles@2
        displayName: 'copy nuget package to $(build.ArtifactStagingDirectory)'
        inputs:
          SourceFolder: packages
          Contents: '**/*.nuget'
          TargetFolder: '$(build.ArtifactStagingDirectory)'

      - publish: packages
        artifact: 'Shared'
        displayName: 'Publish shared library'

  - stage: 'Publish'
    displayName: 'Publish to Azure Artifacts'
    jobs:
    - job: PublishNuGetJob
      displayName: 'Publish NuGet Package to Azure Artifacts'
      pool:
        vmImage: ubuntu-latest
      
      steps:
        - download: current
          artifact: 'Shared'
          patterns: '**/*.nuget'
          displayName: 'Download pipeline artifact'
        
